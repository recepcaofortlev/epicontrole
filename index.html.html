<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Controle de Estoque de EPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
        }
        /* Estilo para animação de destaque em linhas com atraso */
        .overdue-alert {
            background-color: #fef2f2 !important; /* Fundo vermelho bem claro */
            animation: pulse-bg 2s infinite;
        }
        @keyframes pulse-bg {
            0% { background-color: #fef2f2; }
            50% { background-color: #fee2e2; }
            100% { background-color: #fef2f2; }
        }
        /* Estilo para o modal de mensagem */
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Controle de Estoque de EPIs para Visitantes</h1>
            <p class="text-gray-600 mt-1">Gerencie retiradas e devoluções de forma prática e automatizada.</p>
        </header>

        <!-- Seção de Alertas -->
        <div class="grid grid-cols-1 gap-6 mb-8">
            <!-- Card de Alertas -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Alertas de Devolução
                </h2>
                <div id="overdue-alerts" class="space-y-2 text-sm">
                    <p class="text-gray-500">Nenhum item com devolução atrasada.</p>
                </div>
            </div>
        </div>

        <!-- Card de Registro de Retirada -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Registrar Nova Retirada</h2>
            <form id="withdrawal-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                <div>
                    <label for="visitor" class="block text-sm font-medium text-gray-700">Visitante</label>
                    <input type="text" id="visitor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                </div>
                <div>
                    <label for="sector" class="block text-sm font-medium text-gray-700">Setor</label>
                    <input type="text" id="sector" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                </div>
                <div>
                    <label for="item" class="block text-sm font-medium text-gray-700">Item</label>
                    <select id="item" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        <!-- Opções de itens serão inseridas aqui -->
                    </select>
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="quantity" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold rounded-md shadow-sm h-10 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Confirmar Retirada
                </button>
            </form>
        </div>

        <!-- Card de Status do Estoque -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Status do Estoque Atual</h2>
            <div id="stock-status" class="space-y-3">
                <!-- O status do estoque será inserido aqui pelo JavaScript -->
            </div>
        </div>

        <!-- Tabela de Controle -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
             <h2 class="text-xl font-semibold text-gray-700 p-6">Histórico de Movimentações</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visitante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Retirado</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora da Retirada</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Devolvido</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- As linhas do histórico serão inseridas aqui -->
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500" id="empty-log-message">Nenhuma movimentação registrada.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para mensagens -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="modal-text" class="text-lg text-gray-700"></p>
            <button id="modal-close-btn" class="mt-4 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-indigo-700">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO INICIAL DA APLICAÇÃO ---
            let stock = [
                { id: 1, name: 'Óculos', initial: 3, current: 3 },
                { id: 2, name: 'Óculos de Sobrepor', initial: 4, current: 4 },
                { id: 3, name: 'Colete', initial: 4, current: 4 },
                { id: 4, name: 'Capacete', initial: 3, current: 3 },
            ];
            
            // Tenta carregar dados do localStorage
            const savedStock = localStorage.getItem('epiStock');
            const savedLog = localStorage.getItem('epiLog');

            let log = savedLog ? JSON.parse(savedLog) : [];
            if (savedStock) {
                stock = JSON.parse(savedStock);
            }

            // --- REFERÊNCIAS DO DOM ---
            const stockStatusDiv = document.getElementById('stock-status');
            const itemSelect = document.getElementById('item');
            const withdrawalForm = document.getElementById('withdrawal-form');
            const logTableBody = document.getElementById('log-table-body');
            const emptyLogMessage = document.getElementById('empty-log-message');
            const overdueAlertsDiv = document.getElementById('overdue-alerts');

            const messageModal = document.getElementById('message-modal');
            const modalText = document.getElementById('modal-text');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            
            // Atualiza o card de status do estoque
            function renderStockStatus() {
                stockStatusDiv.innerHTML = '';
                stock.forEach(item => {
                    const percentage = (item.current / item.initial) * 100;
                    let bgColor = 'bg-green-500';
                    if (percentage < 50) bgColor = 'bg-yellow-500';
                    if (percentage < 25) bgColor = 'bg-red-500';

                    const itemHtml = `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">${item.name}</span>
                                <span class="text-sm font-semibold text-gray-800">${item.current} / ${item.initial}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="${bgColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                    stockStatusDiv.insertAdjacentHTML('beforeend', itemHtml);
                });
            }

            // Popula o select de itens no formulário
            function populateItemSelect() {
                itemSelect.innerHTML = '';
                stock.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    itemSelect.appendChild(option);
                });
            }

            // Atualiza a tabela de histórico de movimentações
            function renderLogTable() {
                logTableBody.innerHTML = '';
                if (log.length === 0) {
                    emptyLogMessage.parentElement.style.display = 'table-row';
                } else {
                    if(emptyLogMessage) emptyLogMessage.parentElement.style.display = 'none';
                    
                    log.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Ordena do mais novo para o mais antigo
                    
                    log.forEach(entry => {
                        const item = stock.find(s => s.id === parseInt(entry.itemId));
                        const isReturned = entry.status === 'returned';
                        const isOverdue = !isReturned && (new Date() - new Date(entry.timestamp)) > 24 * 60 * 60 * 1000;
                        
                        const row = document.createElement('tr');
                        if (isOverdue) {
                            row.classList.add('overdue-alert');
                        }

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.visitor}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.sector}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item ? item.name : 'Item não encontrado'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(entry.timestamp).toLocaleString('pt-BR')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <input type="checkbox" data-log-id="${entry.id}" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 return-checkbox" ${isReturned ? 'checked disabled' : ''}>
                            </td>
                        `;
                        logTableBody.appendChild(row);
                    });
                }
            }

            // Atualiza o card de alertas de devolução
            function checkAndRenderAlerts() {
                const overdueItems = log.filter(entry => entry.status === 'withdrawn' && (new Date() - new Date(entry.timestamp)) > 24 * 60 * 60 * 1000);

                overdueAlertsDiv.innerHTML = '';

                if (overdueItems.length === 0) {
                    overdueAlertsDiv.innerHTML = '<p class="text-gray-500">Nenhum item com devolução atrasada.</p>';
                } else {
                    overdueItems.forEach(entry => {
                         const item = stock.find(s => s.id === parseInt(entry.itemId));
                         const alertHtml = `
                            <div class="bg-red-50 border-l-4 border-red-400 p-3 rounded-r-lg">
                                <p class="font-semibold text-red-800">${item.name} (${entry.quantity})</p>
                                <p class="text-red-700">Retirado por: <strong>${entry.visitor}</strong></p>
                                <p class="text-red-700">Atrasado desde: ${new Date(new Date(entry.timestamp).getTime() + 24*60*60*1000).toLocaleDateString('pt-BR')}</p>
                            </div>
                         `;
                         overdueAlertsDiv.insertAdjacentHTML('beforeend', alertHtml);
                    });
                }
            }
            
            // --- FUNÇÕES DE LÓGICA ---
            
            // Salva o estado atual no localStorage
            function saveData() {
                localStorage.setItem('epiStock', JSON.stringify(stock));
                localStorage.setItem('epiLog', JSON.stringify(log));
            }

            // Mostra uma mensagem no modal
            function showMessage(message) {
                modalText.textContent = message;
                messageModal.classList.remove('opacity-0', 'pointer-events-none');
            }

            // Esconde o modal
            function hideMessage() {
                messageModal.classList.add('opacity-0', 'pointer-events-none');
            }

            // Lida com o evento de retirada de item
            function handleWithdrawal(event) {
                event.preventDefault();

                const visitor = document.getElementById('visitor').value.trim();
                const sector = document.getElementById('sector').value.trim();
                const itemId = parseInt(itemSelect.value);
                const quantity = parseInt(document.getElementById('quantity').value);

                if (!visitor || !sector || isNaN(itemId) || isNaN(quantity) || quantity <= 0) {
                    showMessage('Por favor, preencha todos os campos corretamente.');
                    return;
                }

                const stockItem = stock.find(item => item.id === itemId);

                if (stockItem.current < quantity) {
                    showMessage(`Estoque insuficiente. Restam apenas ${stockItem.current} unidades de ${stockItem.name}.`);
                    return;
                }

                // Atualiza o estoque
                stockItem.current -= quantity;

                // Adiciona ao log
                const newLogEntry = {
                    id: Date.now(), // ID único baseado no timestamp
                    visitor,
                    sector,
                    itemId,
                    quantity,
                    timestamp: new Date().toISOString(),
                    status: 'withdrawn'
                };
                log.push(newLogEntry);
                
                // Limpa o formulário
                withdrawalForm.reset();

                // Atualiza a UI e salva os dados
                updateUI();
                saveData();
                showMessage('Retirada registrada com sucesso!');
            }

            // Lida com a devolução de item (clique na checkbox)
            function handleReturn(event) {
                if (event.target.classList.contains('return-checkbox') && !event.target.disabled) {
                    const logId = parseInt(event.target.dataset.logId);
                    const logEntry = log.find(entry => entry.id === logId);

                    if (logEntry && logEntry.status === 'withdrawn') {
                        const stockItem = stock.find(item => item.id === parseInt(logEntry.itemId));
                        
                        // Atualiza o estoque
                        stockItem.current += logEntry.quantity;

                        // Atualiza o status do log
                        logEntry.status = 'returned';

                        // Desabilita a checkbox
                        event.target.disabled = true;

                        // Atualiza a UI e salva os dados
                        updateUI();
                        saveData();
                        showMessage('Devolução registrada com sucesso!');
                    }
                }
            }

            // Função central para atualizar toda a interface
            function updateUI() {
                renderStockStatus();
                renderLogTable();
                checkAndRenderAlerts();
            }

            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            withdrawalForm.addEventListener('submit', handleWithdrawal);
            logTableBody.addEventListener('change', handleReturn);
            modalCloseBtn.addEventListener('click', hideMessage);
            
            // Inicia a verificação de alertas a cada minuto
            setInterval(() => {
                checkAndRenderAlerts();
                renderLogTable(); // Re-renderiza a tabela para atualizar a classe de destaque
            }, 60000);

            // Primeira renderização ao carregar a página
            populateItemSelect();
            updateUI();
        });
    </script>
</body>
</html>

